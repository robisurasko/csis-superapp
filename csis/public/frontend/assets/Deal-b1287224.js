import{_ as Me,a as Se}from"./Resizer-d799806c.js";import{_ as Ae}from"./FadedScrollableDiv-f3f408b5.js";import{u as Re,_ as Te,a as Ee,b as Ne,A as se,S as Ue,L as Oe,c as Be}from"./useActiveTabManager-a0215a12.js";import{E as qe}from"./MultiSelectEmailInput-5ae16f74.js";import{E as ne}from"./Email2Icon-d49a0a62.js";import{C as Pe}from"./CommentIcon-2d82e902.js";import{D as je}from"./DetailsIcon-404b02bf.js";import{P as W}from"./PhoneIcon-cb5df69f.js";import{T as Le}from"./TaskIcon-f5c3d969.js";import{N as Fe}from"./NoteModal-4abb9e0a.js";import{W as We}from"./WhatsAppIcon-cd469fd1.js";import{I as Ge}from"./IndicatorIcon-99f76624.js";import{L as He}from"./LinkIcon-c228db3f.js";import{A as Je}from"./ArrowUpRightIcon-fffd9b01.js";import{S as Ke,g as Qe,a as Xe}from"./view-de8292bb.js";import{_ as Ye}from"./LayoutHeader-448e93da.js";import{_ as Ze}from"./OrganizationModal-b2c5c5b4.js";import{C as ea}from"./ContactModal-e2b879e7.js";import{c as aa,_ as ta,w as oa}from"./Link-4317fd36.js";import{_ as sa}from"./Section-7d029c27.js";import{_ as na}from"./CustomActions-4107b940.js";import{g as la,b as ra,s as ia,d as da,e as ca,a as le,o as ma}from"./index-31644aa3.js";import{g as ua}from"./settings-5fcce07e.js";import{s as _a}from"./statuses-1a7b8e83.js";import{l as y,z as M,G as u,E as S,a as pa,o as fa,j as G,A as ga,c as g,u as t,g as h,w as r,p,b as o,H,F as re,h as va,B as ya,e as J,f as m,n as K,d as c,t as C,_ as z,r as ba,D as ie,x as ha}from"./index-85632e04.js";import{_ as Ca}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-41a5d25f.js";import{_ as de}from"./Dropdown.vue_vue_type_script_setup_true_lang-4f930b23.js";import{a as xa}from"./QuickEntryModal-157d8856.js";import{u as wa}from"./helpCenter-64650aa2.js";import"./CalendarIcon-b9320815.js";import"./CallLogModal-359f4190.js";import"./DragVerticalIcon-e7d3e46c.js";import"./ContactsIcon-830ef67e.js";import"./LeadsIcon-68ebc4cc.js";import"./DealsIcon-acabc22f.js";import"./TaskModal-d0e5aa30.js";import"./MultipleAvatar-8c461416.js";import"./IconPicker-0c2832fa.js";import"./Popover-4a1551e7.js";import"./FileUploader-ffa5e39e.js";import"./EmailTemplateModal-adfdb337.js";import"./AssignmentModal-f44425e3.js";const ka={key:1,class:"flex h-full overflow-hidden"},Ia={class:"flex items-center justify-start gap-5 border-b p-5"},za={class:"group relative size-12"},Da={class:"flex flex-col gap-2.5 truncate text-ink-gray-9"},Va={class:"truncate text-2xl font-medium"},$a={class:"flex gap-1.5"},Ma={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Sa={key:0,class:"pr-2"},Aa={key:0,class:"contacts-area"},Ra={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-ink-gray-4"},Ta={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-ink-gray-7"},Ea=["onClick"],Na={class:"truncate"},Ua={class:"flex items-center"},Oa={class:"flex flex-col gap-1.5 text-base text-ink-gray-8"},Ba={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},qa={class:"flex items-center gap-3 p-1 py-1.5"},Pa={key:0,class:"mx-2 h-px border-t border-outline-gray-modals"},ja={key:2,class:"flex h-20 items-center justify-center text-base text-ink-gray-5"},St={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(ce){const{brand:me}=ua(),{$dialog:ue,$socket:E,makeCall:_e}=la(),{statusOptions:pe,getDealStatus:fe}=_a(),{doctypeMeta:ge}=ra("CRM Deal"),{updateOnboardingStep:ve,isOnboardingStepsCompleted:ye}=wa("frappecrm"),x=va(),D=ya(),v=ce,A=y(""),N=y(""),s=M({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:v.dealId},cache:["deal",v.dealId],onSuccess:a=>{A.value="",N.value="",a.organization&&(V.update({params:{doctype:"CRM Organization",name:a.organization}}),V.fetch()),ia(s),da(s,{doc:a,$dialog:ue,$socket:E,router:D,toast:u,updateField:T,createToast:u.create,deleteDoc:De,resource:{deal:s,dealContacts:_,sections:k},call:S})},onError:a=>{var e,l;(e=a.messages)!=null&&e[0]?(A.value=__("Not permitted"),N.value=__((l=a.messages)==null?void 0:l[0])):D.push({name:"Deals"})}}),V=M({url:"frappe.client.get",onSuccess:a=>s.data._organizationObj=a});pa(()=>{if(E.on("crm_customer_created",()=>{u.success(__("Customer created successfully"))}),s.data){V.data=s.data._organizationObj;return}s.fetch()}),fa(()=>{E.off("crm_customer_created")});const U=y(!1),O=y(!1),B=y(!1),q=y({});function be(a,e,l){e=Array.isArray(a)?"":e,!he(a,e)&&M({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:v.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{s.reload(),U.value=!0,u.success(__("Deal updated")),l==null||l()},onError:i=>{var I;u.error(__("Error updating deal: {0}",[(I=i.messages)==null?void 0:I[0]]))}})}function he(a,e){var i;let l=s.data.fields_meta||{};return(i=l[a])!=null&&i.reqd&&!e?(u.error(__("{0} is a required field",[l[a].label])),!0):!1}const Ce=G(()=>{let a=[{label:__("Deals"),route:{name:"Deals"}}];if(x.query.view||x.query.viewType){let e=Qe(x.query.view,x.query.viewType,"CRM Deal");e&&a.push({label:__(e.label),icon:e.icon,route:{name:"Deals",params:{viewType:x.query.viewType},query:{view:x.query.view}}})}return a.push({label:R.value,route:{name:"Deal",params:{dealId:s.data.name}}}),a}),R=G(()=>{var e,l;let a=((e=ge["CRM Deal"])==null?void 0:e.title_field)||"name";return((l=s.data)==null?void 0:l[a])||v.dealId});ga(()=>({title:R.value,icon:me.favicon}));const P=G(()=>[{name:"Activity",label:__("Activity"),icon:Be},{name:"Emails",label:__("Emails"),icon:qe},{name:"Comments",label:__("Comments"),icon:Pe},{name:"Data",label:__("Data"),icon:je},{name:"Calls",label:__("Calls"),icon:W},{name:"Tasks",label:__("Tasks"),icon:Le},{name:"Notes",label:__("Notes"),icon:Fe},{name:"Attachments",label:__("Attachments"),icon:se},{name:"WhatsApp",label:__("WhatsApp"),icon:We,condition:()=>oa.value}].filter(e=>e.condition?e.condition():!0)),{tabIndex:w}=Re(P,"lastDealTab"),k=M({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Deal"],params:{doctype:"CRM Deal"},transform:a=>xe(a)});k.data||k.fetch();function xe(a){return a.forEach(e=>{e.name!="contacts_section"&&e.columns[0].fields.forEach(l=>{l.fieldname=="organization"&&(l.create=(i,I)=>{q.value.organization_name=i,O.value=!0,I()},l.link=i=>D.push({name:"Organization",params:{organizationId:i}}))})}),a}const j=y(!1),Q=y({});function we(a){let e=[{label:__("Remove"),icon:"trash-2",onClick:()=>ke(a.name)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:ha(Xe,{class:"h-4 w-4"}),onClick:()=>Ie(a.name)}),e}async function L(a){var l;if((l=_.data)!=null&&l.find(i=>i.name===a)){u.error(__("Contact already added"));return}await S("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:v.dealId,contact:a})&&(_.reload(),u.success(__("Contact added")))}async function ke(a){await S("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:v.dealId,contact:a})&&(_.reload(),u.success(__("Contact removed")))}async function Ie(a){await S("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:v.dealId,contact:a})&&(_.reload(),u.success(__("Primary contact set")))}const _=M({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:v.dealId},cache:["deal_contacts",v.dealId],transform:a=>(a.forEach(e=>{e.opened=!1}),a)});_.data||_.fetch();function ze(){var l;let a=(l=_.data)==null?void 0:l.find(i=>i.is_primary),e=a.mobile_no||null;if(!a){u.error(__("No primary contact set"));return}if(!e){u.error(__("No mobile number set"));return}_e(e)}function T(a,e,l){a=="status"&&!ye.value&&ve("change_deal_status"),be(a,e,()=>{s.data[a]=e,l==null||l()})}async function De(a){await S("frappe.client.delete",{doctype:"CRM Deal",name:a}),D.push({name:"Deals"})}const F=y(null);function Ve(){F.value.emailBox.show=!0}return(a,e)=>{var X;const l=J("FeatherIcon"),i=J("Button"),I=J("Badge");return m(),g(re,null,[t(s).data?(m(),h(Ye,{key:0},{"left-header":r(()=>[o(t(Ca),{items:Ce.value},{prefix:r(({item:n})=>[n.icon?(m(),h(Ae,{key:0,icon:n.icon,class:"mr-2 h-4"},null,8,["icon"])):p("",!0)]),_:1},8,["items"])]),"right-header":r(()=>{var n;return[(n=t(s).data._customActions)!=null&&n.length?(m(),h(na,{key:0,actions:t(s).data._customActions},null,8,["actions"])):p("",!0),o(Ee,{modelValue:t(s).data._assignedTo,"onUpdate:modelValue":e[0]||(e[0]=d=>t(s).data._assignedTo=d),data:t(s).data,doctype:"CRM Deal"},null,8,["modelValue","data"]),o(t(de),{options:t(pe)("deal",T,t(s).data._customStatuses)},{default:r(({open:d})=>[o(i,{label:t(s).data.status},{prefix:r(()=>[o(Ge,{class:K(t(fe)(t(s).data.status).color)},null,8,["class"])]),suffix:r(()=>[o(l,{name:d?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label"])]),_:1},8,["options"])]}),_:1})):p("",!0),t(s).data?(m(),g("div",ka,[o(t(xa),{as:"div",modelValue:t(w),"onUpdate:modelValue":e[4]||(e[4]=n=>H(w)?w.value=n:null),tabs:P.value},{"tab-panel":r(()=>[o(Ne,{ref_key:"activities",ref:F,doctype:"CRM Deal",tabs:P.value,reload:U.value,"onUpdate:reload":e[1]||(e[1]=n=>U.value=n),tabIndex:t(w),"onUpdate:tabIndex":e[2]||(e[2]=n=>H(w)?w.value=n:null),modelValue:t(s),"onUpdate:modelValue":e[3]||(e[3]=n=>H(s)?s.value=n:null)},null,8,["tabs","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(Me,{side:"right",class:"flex flex-col justify-between border-l"},{default:r(()=>{var n;return[c("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9",onClick:e[5]||(e[5]=d=>t(ca)(t(s).data.name))},C(a.__(t(s).data.name)),1),c("div",Ia,[o(t(z),{text:a.__("Organization logo")},{default:r(()=>{var d;return[c("div",za,[o(t(le),{size:"3xl",class:"size-12",label:R.value,image:(d=t(V).data)==null?void 0:d.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),c("div",Da,[o(t(z),{text:((n=t(V).data)==null?void 0:n.name)||a.__("Set an organization")},{default:r(()=>[c("div",Va,C(R.value),1)]),_:1},8,["text"]),c("div",$a,[t(aa)?(m(),h(t(z),{key:0,text:a.__("Make a call")},{default:r(()=>[c("div",null,[o(i,{class:"h-7 w-7",onClick:ze},{default:r(()=>[o(W,{class:"h-4 w-4"})]),_:1})])]),_:1},8,["text"])):p("",!0),o(t(z),{text:a.__("Send an email")},{default:r(()=>[c("div",null,[o(i,{class:"h-7 w-7"},{default:r(()=>[o(ne,{class:"h-4 w-4",onClick:e[6]||(e[6]=d=>t(s).data.email?Ve():t(u).error(a.__("No email set")))})]),_:1})])]),_:1},8,["text"]),o(t(z),{text:a.__("Go to website")},{default:r(()=>[c("div",null,[o(i,{class:"h-7 w-7"},{default:r(()=>[o(He,{class:"h-4 w-4",onClick:e[7]||(e[7]=d=>t(s).data.website?t(ma)(t(s).data.website):t(u).error(a.__("No website set")))})]),_:1})])]),_:1},8,["text"]),o(t(z),{text:a.__("Attach a file")},{default:r(()=>[c("div",null,[o(i,{class:"size-7",onClick:e[8]||(e[8]=d=>B.value=!0)},{default:r(()=>[o(se,{class:"size-4"})]),_:1})])]),_:1},8,["text"])])])]),t(s).data.sla_status?(m(),h(Ue,{key:0,modelValue:t(s).data,"onUpdate:modelValue":e[9]||(e[9]=d=>t(s).data=d),onUpdateField:T},null,8,["modelValue"])):p("",!0),t(k).data?(m(),g("div",Ma,[o(Ke,{sections:t(k).data,addContact:L,doctype:"CRM Deal",docname:t(s).data.name,onReload:t(k).reload},{actions:r(({section:d})=>[d.name=="contacts_section"?(m(),g("div",Sa,[o(ta,{value:"",doctype:"Contact",onChange:e[10]||(e[10]=b=>L(b)),onCreate:(b,$)=>{Q.value={first_name:b,company_name:t(s).data.organization},j.value=!0,$()}},{target:r(({togglePopover:b})=>[o(i,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:$=>b()},null,8,["onClick"])]),_:1},8,["onCreate"])])):p("",!0)]),default:r(({section:d})=>{var b,$,Y,Z,ee;return[d.name=="contacts_section"?(m(),g("div",Aa,[(b=t(_))!=null&&b.loading&&((Y=($=t(_))==null?void 0:$.data)==null?void 0:Y.length)==0?(m(),g("div",Ra,[o(Oe,{class:"h-4 w-4"}),c("span",null,C(a.__("Loading...")),1)])):(ee=(Z=t(_))==null?void 0:Z.data)!=null&&ee.length?(m(!0),g(re,{key:1},ba(t(_).data,(f,ae)=>(m(),g("div",{key:f.name},[c("div",{class:K(["px-2 pb-2.5",[ae==0?"pt-5":"pt-2.5"]])},[o(sa,{opened:f.opened},{header:r(({opened:$e,toggle:te})=>[c("div",Ta,[c("div",{class:"flex h-7 items-center gap-2 truncate",onClick:oe=>te()},[o(t(le),{label:f.full_name,image:f.image,size:"md"},null,8,["label","image"]),c("div",Na,C(f.full_name),1),f.is_primary?(m(),h(I,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):p("",!0)],8,Ea),c("div",Ua,[o(t(de),{options:we(f)},{default:r(()=>[o(i,{icon:"more-horizontal",class:"text-ink-gray-5",variant:"ghost"})]),_:2},1032,["options"]),o(i,{variant:"ghost",onClick:oe=>t(D).push({name:"Contact",params:{contactId:f.name}})},{default:r(()=>[o(Je,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(i,{variant:"ghost",onClick:oe=>te()},{default:r(()=>[o(l,{name:"chevron-right",class:K(["h-4 w-4 text-ink-gray-9 transition-all duration-300 ease-in-out",{"rotate-90":$e}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:r(()=>[c("div",Oa,[c("div",Ba,[o(ne,{class:"h-4 w-4"}),ie(" "+C(f.email),1)]),c("div",qa,[o(W,{class:"h-4 w-4"}),ie(" "+C(f.mobile_no),1)])])]),_:2},1032,["opened"])],2),ae!=t(_).data.length-1?(m(),g("div",Pa)):p("",!0)]))),128)):(m(),g("div",ja,C(a.__("No contacts added")),1))])):p("",!0)]}),_:1},8,["sections","docname","onReload"])])):p("",!0)]}),_:1})])):A.value?(m(),h(Se,{key:2,errorTitle:A.value,errorMessage:N.value},null,8,["errorTitle","errorMessage"])):p("",!0),o(Ze,{modelValue:O.value,"onUpdate:modelValue":e[11]||(e[11]=n=>O.value=n),organization:q.value,"onUpdate:organization":e[12]||(e[12]=n=>q.value=n),options:{redirect:!1,afterInsert:n=>T("organization",n.name)}},null,8,["modelValue","organization","options"]),o(ea,{modelValue:j.value,"onUpdate:modelValue":e[13]||(e[13]=n=>j.value=n),contact:Q.value,options:{redirect:!1,afterInsert:n=>L(n.name)}},null,8,["modelValue","contact","options"]),(X=t(s).data)!=null&&X.name?(m(),h(Te,{key:3,modelValue:B.value,"onUpdate:modelValue":e[14]||(e[14]=n=>B.value=n),doctype:"CRM Deal",docname:t(s).data.name,onAfter:e[15]||(e[15]=()=>{var n,d;(d=(n=F.value)==null?void 0:n.all_activities)==null||d.reload(),a.changeTabTo("attachments")})},null,8,["modelValue","docname"])):p("",!0)],64)}}};export{St as default};
//# sourceMappingURL=Deal-b1287224.js.map
