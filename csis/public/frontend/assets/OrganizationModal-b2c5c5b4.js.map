{"version":3,"file":"OrganizationModal-b2c5c5b4.js","sources":["../../../../frontend/src/components/Modals/OrganizationModal.vue"],"sourcesContent":["<template>\n  <Dialog v-model=\"show\" :options=\"{ size: 'xl' }\">\n    <template #body>\n      <div class=\"px-4 pt-5 pb-6 bg-surface-modal sm:px-6\">\n        <div class=\"flex items-center justify-between mb-5\">\n          <div>\n            <h3 class=\"text-2xl font-semibold leading-6 text-ink-gray-9\">\n              {{ __('New Organization') }}\n            </h3>\n          </div>\n          <div class=\"flex items-center gap-1\">\n            <Button v-if=\"isManager() && !isMobileView\" variant=\"ghost\" class=\"w-7\" @click=\"openQuickEntryModal\">\n              <EditIcon class=\"w-4 h-4\" />\n            </Button>\n            <Button variant=\"ghost\" class=\"w-7\" @click=\"show = false\">\n              <FeatherIcon name=\"x\" class=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n        <FieldLayout v-if=\"tabs.data?.length\" :tabs=\"tabs.data\" :data=\"_organization\" doctype=\"CRM Organization\" />\n        <ErrorMessage class=\"mt-8\" v-if=\"error\" :message=\"__(error)\" />\n      </div>\n      <div class=\"px-4 pt-4 pb-7 sm:px-6\">\n        <div class=\"space-y-2\">\n          <Button class=\"w-full\" variant=\"solid\" :label=\"__('Create')\" :loading=\"loading\" @click=\"createOrganization\" />\n        </div>\n      </div>\n    </template>\n  </Dialog>\n</template>\n\n<script setup>\nimport FieldLayout from '@/components/FieldLayout/FieldLayout.vue'\nimport EditIcon from '@/components/Icons/EditIcon.vue'\nimport { usersStore } from '@/stores/users'\nimport { isMobileView } from '@/composables/settings'\nimport { capture } from '@/telemetry'\nimport { call, FeatherIcon, createResource } from 'frappe-ui'\nimport { ref, nextTick, watch } from 'vue'\nimport { useRouter } from 'vue-router'\n\nconst props = defineProps({\n  options: {\n    type: Object,\n    default: {\n      redirect: true,\n      afterInsert: () => { },\n    },\n  },\n})\n\nconst emit = defineEmits(['openAddressModal'])\n\nconst { isManager } = usersStore()\n\nconst router = useRouter()\nconst show = defineModel()\nconst organization = defineModel('organization')\n\nconst loading = ref(false)\nconst title = ref(null)\n\nlet _organization = ref({\n  organization_name: '',\n  website: '',\n  annual_revenue: '',\n  no_of_employees: '1-10',\n  industry: '',\n})\n\nlet doc = ref({})\nconst error = ref(null)\n\nasync function createOrganization() {\n  const doc = await call('frappe.client.insert', {\n    doc: {\n      doctype: 'CRM Organization',\n      ..._organization.value,\n    },\n  }, {\n    onError: (err) => {\n      if (err.error.exc_type == 'ValidationError') {\n        error.value = err.error?.messages?.[0]\n      }\n    }\n  })\n  loading.value = false\n  if (doc.name) {\n    capture('organization_created')\n    handleOrganizationUpdate(doc)\n  }\n}\n\nfunction handleOrganizationUpdate(doc) {\n  if (doc.name && props.options.redirect) {\n    router.push({\n      name: 'Organization',\n      params: { organizationId: doc.name },\n    })\n  } else {\n    organization.value?.reload?.()\n  }\n  show.value = false\n  props.options.afterInsert && props.options.afterInsert(doc)\n}\n\nconst tabs = createResource({\n  url: 'crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout',\n  cache: ['QuickEntry', 'CRM Organization'],\n  params: { doctype: 'CRM Organization', type: 'Quick Entry' },\n  auto: true,\n  transform: (_tabs) => {\n    return _tabs.forEach((tab) => {\n      tab.sections.forEach((section) => {\n        section.columns.forEach((column) => {\n          column.fields.forEach((field) => {\n            if (field.fieldname == 'address') {\n              field.create = (value, close) => {\n                _organization.value.address = value\n                emit('openAddressModal')\n                show.value = false\n                close()\n              }\n              field.edit = (address) => {\n                emit('openAddressModal', address)\n                show.value = false\n              }\n            } else if (field.fieldtype === 'Table') {\n              _organization.value[field.fieldname] = []\n            }\n          })\n        })\n      })\n    })\n  },\n})\n\nwatch(\n  () => show.value,\n  (value) => {\n    if (!value) return\n    nextTick(() => {\n      // TODO: Issue with FormControl\n      // title.value.el.focus()\n      doc.value = organization.value?.doc || organization.value || {}\n      _organization.value = { ...doc.value }\n    })\n  },\n)\n\nconst showQuickEntryModal = defineModel('showQuickEntryModal')\n\nfunction openQuickEntryModal() {\n  showQuickEntryModal.value = true\n  nextTick(() => (show.value = false))\n}\n</script>\n"],"names":["props","__props","emit","__emit","isManager","usersStore","router","useRouter","show","_useModel","organization","loading","ref","_organization","doc","error","createOrganization","call","err","_b","_a","capture","handleOrganizationUpdate","tabs","createResource","_tabs","tab","section","column","field","value","close","address","watch","nextTick","showQuickEntryModal","openQuickEntryModal"],"mappings":"s8BAyCA,MAAMA,EAAQC,EAURC,EAAOC,EAEP,CAAE,UAAAC,CAAW,EAAGC,EAAW,EAE3BC,EAASC,EAAU,EACnBC,EAAOC,EAAYR,EAAA,YAAA,EACnBS,EAAeD,EAAWR,EAAC,cAAc,EAEzCU,EAAUC,EAAI,EAAK,EACXA,EAAI,IAAI,EAEtB,IAAIC,EAAgBD,EAAI,CACtB,kBAAmB,GACnB,QAAS,GACT,eAAgB,GAChB,gBAAiB,OACjB,SAAU,EACZ,CAAC,EAEGE,EAAMF,EAAI,EAAE,EAChB,MAAMG,EAAQH,EAAI,IAAI,EAEtB,eAAeI,GAAqB,CAClC,MAAMF,EAAM,MAAMG,EAAK,uBAAwB,CAC7C,IAAK,CACH,QAAS,mBACT,GAAGJ,EAAc,KAClB,CACL,EAAK,CACD,QAAUK,GAAQ,SACZA,EAAI,MAAM,UAAY,oBACxBH,EAAM,OAAQI,GAAAC,EAAAF,EAAI,QAAJ,YAAAE,EAAW,WAAX,YAAAD,EAAsB,GAExC,CACJ,CAAG,EACDR,EAAQ,MAAQ,GACZG,EAAI,OACNO,EAAQ,sBAAsB,EAC9BC,EAAyBR,CAAG,EAEhC,CAEA,SAASQ,EAAyBR,EAAK,SACjCA,EAAI,MAAQd,EAAM,QAAQ,SAC5BM,EAAO,KAAK,CACV,KAAM,eACN,OAAQ,CAAE,eAAgBQ,EAAI,IAAM,CAC1C,CAAK,GAEDK,GAAAC,EAAAV,EAAa,QAAb,YAAAU,EAAoB,SAApB,MAAAD,EAAA,KAAAC,GAEFZ,EAAK,MAAQ,GACbR,EAAM,QAAQ,aAAeA,EAAM,QAAQ,YAAYc,CAAG,CAC5D,CAEA,MAAMS,EAAOC,EAAe,CAC1B,IAAK,yEACL,MAAO,CAAC,aAAc,kBAAkB,EACxC,OAAQ,CAAE,QAAS,mBAAoB,KAAM,aAAe,EAC5D,KAAM,GACN,UAAYC,GACHA,EAAM,QAASC,GAAQ,CAC5BA,EAAI,SAAS,QAASC,GAAY,CAChCA,EAAQ,QAAQ,QAASC,GAAW,CAClCA,EAAO,OAAO,QAASC,GAAU,CAC3BA,EAAM,WAAa,WACrBA,EAAM,OAAS,CAACC,EAAOC,IAAU,CAC/BlB,EAAc,MAAM,QAAUiB,EAC9B5B,EAAK,kBAAkB,EACvBM,EAAK,MAAQ,GACbuB,EAAM,CACR,EACAF,EAAM,KAAQG,GAAY,CACxB9B,EAAK,mBAAoB8B,CAAO,EAChCxB,EAAK,MAAQ,EACf,GACSqB,EAAM,YAAc,UAC7BhB,EAAc,MAAMgB,EAAM,SAAS,EAAI,CAAC,EAEtD,CAAW,CACX,CAAS,CACT,CAAO,CACP,CAAK,CAEL,CAAC,EAEDI,EACE,IAAMzB,EAAK,MACVsB,GAAU,CACJA,GACLI,EAAS,IAAM,OAGbpB,EAAI,QAAQM,EAAAV,EAAa,QAAb,YAAAU,EAAoB,MAAOV,EAAa,OAAS,CAAC,EAC9DG,EAAc,MAAQ,CAAE,GAAGC,EAAI,KAAM,CAC3C,CAAK,CACF,CACH,EAEA,MAAMqB,EAAsB1B,EAAYR,EAAA,qBAAqB,EAE7D,SAASmC,GAAsB,CAC7BD,EAAoB,MAAQ,GAC5BD,EAAS,IAAO1B,EAAK,MAAQ,EAAM,CACrC"}